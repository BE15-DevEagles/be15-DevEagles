#!/bin/sh

echo "[Hook] Git pre-commit hook started..."

# Git ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™
PROJECT_ROOT=$(git rev-parse --show-toplevel)
echo "ğŸ“‚ [Info] Project root: $PROJECT_ROOT"

# í˜„ì¬ ìŠ¤í…Œì´ì§€ëœ íŒŒì¼ ëª©ë¡ ì¶”ì¶œ
stagedFiles=$(git diff --cached --name-only)
echo "[Info] Staged files:"
echo "$stagedFiles"

# spotlessApply ì‹¤í–‰
echo "[Action] Running spotlessApply..."
cd "$PROJECT_ROOT" || exit 1

echo "[Debug] Current directory: $(pwd)"

# ë¹Œë“œ íŒŒì¼ì´ ìˆëŠ” BE ë””ë ‰í† ë¦¬ë¡œ ì´ë™
if [ -d "be15_DevEagles_BE" ]; then
  echo "[Debug] Changing to be15_DevEagles_BE directory"
  cd be15_DevEagles_BE || exit 1
  
  # gradlew ì‹¤í–‰
  if [ -f "gradlew.bat" ]; then
    echo "[Debug] Using gradlew.bat"
    ./gradlew.bat spotlessApply
  elif [ -f "gradlew" ]; then
    echo "[Debug] Using gradlew"
    ./gradlew spotlessApply
  else
    echo "[Error] Could not find gradlew or gradlew.bat in BE directory"
    exit 1
  fi
else
  echo "[Error] be15_DevEagles_BE directory not found"
  exit 1
fi

if [ $? -ne 0 ]; then
    echo "âŒ [Error] spotlessApply failed!"
    exit 1
else
    echo "âœ… [Success] spotlessApply completed successfully."
fi

# ë³€ê²½ëœ íŒŒì¼ ë‹¤ì‹œ ìŠ¤í…Œì´ì§•
echo "[Action] Re-adding modified files to staging..."
for file in $stagedFiles; do
  if test -f "$file"; then
    echo "â• Adding: $file"
    git add "$file"
  fi
done

echo "âœ… [Hook] Pre-commit hook finished successfully."
