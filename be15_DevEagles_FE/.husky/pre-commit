#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "[Hook] Git pre-commit hook started..."
echo "ğŸ“‚ [Info] Project root: $(pwd)"

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ ì €ì¥
PROJECT_ROOT=$(pwd)

# ë””ë²„ê¹…: ìŠ¤í…Œì´ì§•ëœ ëª¨ë“  íŒŒì¼ í‘œì‹œ
echo "[Info] Staged files:"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)
echo "$STAGED_FILES"

# í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê²€ì‚¬
echo "[Debug] Checking for JS/Vue files..."
JS_VUE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|vue)$')
echo "[Debug] JS/Vue files found: $JS_VUE_FILES"

if [ -n "$JS_VUE_FILES" ]; then
  echo "[INFO] ë³€ê²½ëœ JS/Vue íŒŒì¼ ê°ì§€ë¨"
  
  # í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
  echo "[Debug] Moving to frontend directory"
  cd "$PROJECT_ROOT" || exit 1
  echo "[Debug] Current directory: $(pwd)"
  
  # package.jsonì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  if [ ! -f "be15_DevEagles_FE/package.json" ]; then
    echo "âŒ [Error] package.json not found in $(pwd)/be15_DevEagles_FE"
    exit 1
  fi
  
  echo "[Action] Running lint-staged for frontend..."
  # lint-stagedë¥¼ í†µí•œ ESLint ë° Prettier ì‹¤í–‰
  cd be15_DevEagles_FE
  export FORCE_COLOR=1
  npx lint-staged
  
  LINT_RESULT=$?
  if [ $LINT_RESULT -ne 0 ]; then
    echo "âŒ [Error] Frontend linting failed! Error code: $LINT_RESULT"
    exit 1
  fi
  
  # ë³€ê²½ëœ í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë‹¤ì‹œ ìŠ¤í…Œì´ì§•
  echo "[Action] Re-adding modified JS/Vue files to staging..."
  cd "$PROJECT_ROOT"
  git add $JS_VUE_FILES
  
  echo "âœ… [Success] Frontend linting completed."
fi

# ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ í•„ìš”í•œ ì²´í¬ ìˆ˜í–‰
echo "[Action] Running spotlessApply..."
cd "$PROJECT_ROOT" || exit 1

echo "[Debug] Current directory: $(pwd)"

# ë¹Œë“œ íŒŒì¼ì´ ìˆëŠ” BE ë””ë ‰í† ë¦¬ë¡œ ì´ë™
if [ -d "be15_DevEagles_BE" ]; then
  echo "[Debug] Changing to be15_DevEagles_BE directory"
  cd be15_DevEagles_BE || exit 1
  
  # gradlew ì‹¤í–‰
  if [ -f "gradlew.bat" ]; then
    echo "[Debug] Using gradlew.bat"
    ./gradlew.bat spotlessApply
  elif [ -f "gradlew" ]; then
    echo "[Debug] Using gradlew"
    ./gradlew spotlessApply
  else
    echo "[Error] Could not find gradlew or gradlew.bat in BE directory"
    exit 1
  fi
else
  echo "[Info] be15_DevEagles_BE directory not found or no Java files changed"
fi

if [ $? -ne 0 ]; then
    echo "âŒ [Error] spotlessApply failed!"
    exit 1
else
    echo "âœ… [Success] spotlessApply completed successfully."
fi

# ë³€ê²½ëœ íŒŒì¼ ë‹¤ì‹œ ìŠ¤í…Œì´ì§•
echo "[Action] Re-adding modified files to staging..."
# ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ëŒì•„ê°€ê¸°
cd "$PROJECT_ROOT" || exit 1
echo "[Debug] Back to root directory: $(pwd)"

for file in $STAGED_FILES; do
  echo "[Debug] Checking file: $file"
  if test -f "$file"; then
    echo "â• Adding: $file"
    git add "$file"
    echo "[Debug] Add result: $?"
  else
    echo "[Warning] File not found: $file"
  fi
done

echo "âœ… [Hook] Pre-commit hook finished successfully."
