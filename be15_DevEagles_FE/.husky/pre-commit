#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "[Hook] Git pre-commit hook started..."
echo "ğŸ“‚ [Info] Project root: $(pwd)"

# ë””ë²„ê¹…: ìŠ¤í…Œì´ì§•ëœ ëª¨ë“  íŒŒì¼ í‘œì‹œ
echo "[Debug] Staged files:"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)
echo "$STAGED_FILES"

# í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ê²€ì‚¬
echo "[Debug] Checking for JS/Vue files..."
JS_VUE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(js|vue)$')
echo "[Debug] JS/Vue files found: $JS_VUE_FILES"

if [ -n "$JS_VUE_FILES" ]; then
  echo "[INFO] ë³€ê²½ëœ JS/Vue íŒŒì¼ ê°ì§€ë¨"
  
  # í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì €ì¥
  PROJECT_ROOT=$(pwd)
  
  # í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
  echo "[Debug] Moving to frontend directory"
  cd be15_DevEagles_FE || exit 1
  
  echo "[Action] Running lint-staged for frontend..."
  # lint-stagedë¥¼ í†µí•œ ESLint ë° Prettier ì‹¤í–‰
  npx lint-staged
  
  LINT_RESULT=$?
  if [ $LINT_RESULT -ne 0 ]; then
    echo "âŒ [Error] Frontend linting failed!"
    exit 1
  fi
  
  echo "âœ… [Success] Frontend linting completed."
  
  # í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¡œ ëŒì•„ê°
  cd "$PROJECT_ROOT" || exit 1
else
  echo "[INFO] ë³€ê²½ëœ JS/Vue íŒŒì¼ ì—†ìŒ, í”„ë¡ íŠ¸ì—”ë“œ ê²€ì‚¬ ê±´ë„ˆëœ€"
fi

# ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•˜ì—¬ í•„ìš”í•œ ì²´í¬ ìˆ˜í–‰
echo "[Debug] Moving to backend directory"
cd be15_DevEagles_BE || exit 1

# ë³€ê²½ëœ Java íŒŒì¼ í™•ì¸
JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.java$')

if [ -n "$JAVA_FILES" ]; then
  echo "[INFO] ë³€ê²½ëœ Java íŒŒì¼ ê°ì§€ë¨"
  
  # Spotlessë¥¼ ì‹¤í–‰í•˜ì—¬ Java ì½”ë“œ ìë™ í¬ë§·íŒ…
  echo "[Action] Running spotlessApply for backend..."
  if [ -f "./gradlew" ]; then
    ./gradlew spotlessApply --daemon
    if [ $? -ne 0 ]; then
      echo "âŒ [Error] spotlessApply failed!"
      exit 1
    fi
    
    # Checkstyle ê²€ì‚¬ ì‹¤í–‰
    echo "[Action] Running checkstyle for backend..."
    ./gradlew checkstyleMain checkstyleTest --daemon
    if [ $? -ne 0 ]; then
      echo "âŒ [Error] Checkstyle failed!"
      exit 1
    fi
    
    # ë³€ê²½ëœ Java íŒŒì¼ ë‹¤ì‹œ ìŠ¤í…Œì´ì§•
    echo "[Action] Re-adding modified Java files to staging..."
    cd ..
    git add $JAVA_FILES
    
    echo "âœ… [Success] Backend code formatting completed."
  else
    echo "âš ï¸ [Warning] gradlew not found, skipping backend checks."
  fi
else
  echo "[INFO] ë³€ê²½ëœ Java íŒŒì¼ ì—†ìŒ, ë°±ì—”ë“œ ê²€ì‚¬ ê±´ë„ˆëœ€"
fi

# í”„ë¡ íŠ¸ì—”ë“œ íŒŒì¼ ë‹¤ì‹œ ìŠ¤í…Œì´ì§• (í¬ë§·íŒ… í›„ ë³€ê²½ë˜ì—ˆì„ ê²½ìš°)
if [ -n "$JS_VUE_FILES" ]; then
  echo "[Action] Re-adding modified JS/Vue files to staging..."
  cd "$(pwd)"
  git add $JS_VUE_FILES
fi

# ì„±ê³µ ë©”ì‹œì§€
echo "âœ… [Hook] ëª¨ë“  ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
